generator client {
  provider      = "prisma-client-js"
  output        = "../generated/prisma"
  binaryTargets = ["debian-openssl-3.0.x", "native"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Accounts {
  id        String   @id @default(uuid())
  username  String   @unique
  role      roleType
  password  String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  regionId  String?
  email     String?
  imageUrl  String?
  region    Regions? @relation(fields: [regionId], references: [id])

  CacheRecords         CacheRecords[]
  responsibleForEvents EventResponsibles[]
  FinancialMovement    FinancialMovement[]
  Inscription          Inscription[]
  payments             Payment[]

  participants AccountParticipant[] @relation("AccountToParticipants")

  @@map("accounts")
}

model AccountParticipant {
  id            String     @id @default(uuid())
  accountId     String     @map("account_id")
  name          String
  preferredName String?    @map("preferred_name")
  shirtSize     ShirtSize? @map("shirt_size")
  shirtType     ShirtType? @map("shirt_type")
  birthDate     DateTime   @map("birth_date")
  gender        genderType
  createdAt     DateTime   @default(now()) @map("created_at")
  updatedAt     DateTime   @updatedAt @map("updated_at")

  account Accounts @relation("AccountToParticipants", fields: [accountId], references: [id], onDelete: Cascade)

  eventLinks AccountParticipantInEvent[] @relation("ParticipantToEvent")

  @@map("account_participants")
}

model AccountParticipantInEvent {
  id                   String   @id @default(uuid())
  accountParticipantId String   @map("account_participant_id")
  inscriptionId        String   @map("inscription_id")
  typeInscriptionId    String   @map("type_inscription_id")
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  participant     AccountParticipant @relation("ParticipantToEvent", fields: [accountParticipantId], references: [id], onDelete: Cascade)
  inscription     Inscription        @relation(fields: [inscriptionId], references: [id], onDelete: Cascade)
  typeInscription TypeInscriptions   @relation(fields: [typeInscriptionId], references: [id])

  @@unique([accountParticipantId, inscriptionId])
  @@map("account_participant_in_event")
}

model Regions {
  id                 String     @id @default(uuid())
  name               String     @unique
  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt
  outstandingBalance Decimal    @default(0.00) @map("outstanding_balance") @db.Decimal(10, 2)
  accounts           Accounts[]
  events             Events[]

  @@map("regions")
}

model Events {
  id                   String               @id @default(uuid())
  name                 String
  createdAt            DateTime             @default(now())
  regionId             String
  amountCollected      Decimal              @default(0.00) @map("amount_collected") @db.Decimal(10, 2)
  imageUrl             String?              @map("image_url")
  quantityParticipants Int                  @default(0) @map("quantity_participants")
  updatedAt            DateTime             @updatedAt
  endDate              DateTime             @map("end_date")
  startDate            DateTime             @map("start_date")
  location             String?
  latitude             Float?
  longitude            Float?
  status               statusEvent
  paymentEnabled       Boolean              @default(false) @map("payment_enabled")
  logoUrl              String?
  ticketEnabled        Boolean              @default(false) @map("ticket_enabled")
  allowCard            Boolean              @default(false) @map("allow_card")
  allowGuest           Boolean              @default(false) @map("allow_guest")
  EventExpenses        EventExpenses[]
  responsibles         EventResponsibles[]
  EventTickets         EventTickets[]
  region               Regions              @relation(fields: [regionId], references: [id])
  FinancialMovement    FinancialMovement[]
  Inscription          Inscription[]
  OnSiteRegistration   OnSiteRegistration[]
  typeInscriptions     TypeInscriptions[]
  payments             Payment[]

  @@map("events")
}

model EventResponsibles {
  id        String   @id @default(uuid())
  eventId   String   @map("event_id")
  accountId String   @map("account_id")
  account   Accounts @relation(fields: [accountId], references: [id])
  event     Events   @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@unique([eventId, accountId])
  @@map("event_responsibles")
}

model TypeInscriptions {
  id                        String                      @id @default(uuid())
  description               String
  value                     Decimal                     @db.Decimal(10, 2)
  eventId                   String                      @map("event_id")
  rule                      DateTime?                   @map("rule")
  specialType               Boolean                     @default(false) @map("special_type")
  createdAt                 DateTime                    @default(now()) @map("created_at")
  updatedAt                 DateTime                    @updatedAt @map("updated_at")
  Participant               Participant[]
  event                     Events                      @relation(fields: [eventId], references: [id])
  accountParticipantInEvent AccountParticipantInEvent[]

  @@map("type_inscriptions")
}

model Inscription {
  id        String  @id @default(uuid())
  accountId String? @map("account_id")

  accessToken               String?                     @unique @default(uuid())
  confirmationCode          String?                     @unique
  guestEmail                String?
  guestName                 String?
  guestLocality             String?
  isGuest                   Boolean                     @default(false)
  eventId                   String                      @map("event_id")
  totalValue                Decimal                     @db.Decimal(10, 2)
  totalPaid                 Decimal                     @default(0.00) @map("total_paid") @db.Decimal(10, 2)
  status                    InscriptionStatus           @default(PENDING)
  expiresAt                 DateTime?                   @map("expires_at")
  cancelledAt               DateTime?                   @map("cancelled_at")
  createdAt                 DateTime                    @default(now()) @map("created_at")
  updatedAt                 DateTime                    @updatedAt @map("updated_at")
  phone                     String
  responsible               String
  email                     String?
  account                   Accounts?                   @relation(fields: [accountId], references: [id])
  event                     Events                      @relation(fields: [eventId], references: [id])
  participants              Participant[]
  accountParticipantInEvent AccountParticipantInEvent[]
  payments                  PaymentAllocation[]
  financialMovements        FinancialMovement[]

  @@index([guestEmail])
  @@index([confirmationCode])
  @@index([accessToken])
  @@index([expiresAt])
  @@map("inscriptions")
}

model Participant {
  id                String           @id @default(uuid())
  inscriptionId     String           @map("inscription_id")
  name              String
  preferredName     String?          @map("preferred_name")
  shirtSize         ShirtSize?       @map("shirt_size")
  shirtType         ShirtType?       @map("shirt_type")
  birthDate         DateTime         @map("birth_date")
  typeInscriptionId String           @map("type_inscription_id")
  createdAt         DateTime         @default(now()) @map("created_at")
  updatedAt         DateTime         @updatedAt @map("updated_at")
  gender            genderType
  inscription       Inscription      @relation(fields: [inscriptionId], references: [id], onDelete: Cascade)
  typeInscription   TypeInscriptions @relation(fields: [typeInscriptionId], references: [id])

  @@map("participants")
}

model CacheRecords {
  id        String    @id @default(uuid())
  cacheKey  String    @unique
  accountId String    @map("account_id")
  expiresAt DateTime?
  createdAt DateTime  @default(now()) @map("created_at")
  payload   Json
  updatedAt DateTime  @updatedAt @map("updated_at")
  account   Accounts  @relation(fields: [accountId], references: [id])

  @@map("cache_records")
}

model OnSiteRegistration {
  id                String              @id @default(uuid())
  eventId           String              @map("event_id")
  phone             String?
  status            InscriptionStatus   @default(PAID)
  createdAt         DateTime            @default(now()) @map("created_at")
  updatedAt         DateTime            @updatedAt @map("updated_at")
  responsible       String
  totalValue        Decimal             @db.Decimal(10, 2)
  OnSiteParticipant OnSiteParticipant[]
  event             Events              @relation(fields: [eventId], references: [id])

  @@map("on_site_registrations")
}

model OnSiteParticipant {
  id                   String                     @id @default(uuid())
  onSiteRegistrationId String                     @map("on_site_registration_id")
  name                 String
  gender               genderType
  createdAt            DateTime                   @default(now()) @map("created_at")
  updatedAt            DateTime                   @updatedAt @map("updated_at")
  payments             OnSiteParticipantPayment[]
  onSiteRegistration   OnSiteRegistration         @relation(fields: [onSiteRegistrationId], references: [id])

  @@map("on_site_participants")
}

model OnSiteParticipantPayment {
  id            String            @id @default(uuid())
  participantId String            @map("participant_id")
  paymentMethod PaymentMethod
  value         Decimal           @db.Decimal(10, 2)
  createdAt     DateTime          @default(now()) @map("created_at")
  participant   OnSiteParticipant @relation(fields: [participantId], references: [id])

  @@map("on_site_participant_payments")
}

model Payment {
  id                String        @id @default(uuid())
  eventId           String        @map("event_id")
  accountId         String?       @map("account_id")
  guestName         String?
  guestEmail        String?       @map("guestEmail")
  accessToken       String?       @unique
  isGuest           Boolean       @default(false)
  status            StatusPayment
  methodPayment     PaymentMethod @default(PIX) @map("method_payment")
  totalValue        Decimal       @default(0) @db.Decimal(10, 2)
  totalNetValue     Decimal       @default(0) @db.Decimal(10, 2)
  totalPaid         Decimal       @default(0) @db.Decimal(10, 2)
  totalReceived     Decimal       @default(0) @db.Decimal(10, 2)
  installments      Int?          @default(1) @map("installment")
  paidInstallments  Int?          @default(0) @map("paid_installments")
  rejectionReason   String?       @map("rejection_reason")
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")
  asaasCheckoutId   String?       @unique @map("asaas_checkout_id")
  paymentLinkId     String?       @map("payment_link_id")
  externalReference String?       @unique @map("external_reference")
  imageUrl          String?
  approvedBy        String?

  account     Accounts?    @relation(fields: [accountId], references: [id])
  paymentLink PaymentLink? @relation(fields: [paymentLinkId], references: [id])
  event       Events       @relation(fields: [eventId], references: [id])

  allocations         PaymentAllocation[]
  paymentInstallments PaymentInstallment[]

  @@index([guestEmail])
  @@map("payments")
}

model PaymentLink {
  id                 String   @id @default(uuid())
  name               String
  description        String
  value              Decimal
  asaasPaymentLinkId String   @unique @map("asaas_payment_link_id")
  url                String
  active             Boolean
  endDateAt          DateTime @map("end_date_at")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  payments Payment[]

  @@map("payment_link")
}

model PaymentInstallment {
  id                  String   @id @default(uuid())
  paymentId           String   @map("payment_id")
  installmentNumber   Int      @map("installment_number")
  received            Boolean  @default(false)
  value               Decimal  @db.Decimal(10, 2)
  netValue            Decimal  @map("net_value") @db.Decimal(10, 2)
  asaasPaymentId      String?  @unique @map("asaas_payment_id")
  financialMovementId String?  @map("financial_movement_id")
  paidAt              DateTime @default(now()) @map("paid_at")
  estimatedAt         DateTime @map("estimated_at")
  createdAt           DateTime @default(now()) @map("created_at")

  payment           Payment            @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  financialMovement FinancialMovement? @relation(fields: [financialMovementId], references: [id])

  @@unique([paymentId, installmentNumber])
  @@map("payment_installments")
}

model PaymentAllocation {
  id            String   @id @default(uuid())
  paymentId     String   @map("payment_id")
  inscriptionId String   @map("inscription_id")
  value         Decimal  @db.Decimal(10, 2)
  createdAt     DateTime @default(now()) @map("created_at")

  payment     Payment     @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  inscription Inscription @relation(fields: [inscriptionId], references: [id], onDelete: Cascade)

  @@unique([paymentId, inscriptionId])
  @@map("payment_allocations")
}

model FinancialMovement {
  id            String          @id @default(uuid())
  eventId       String          @map("event_id")
  accountId     String?         @map("account_id")
  guestEmail    String?
  inscriptionId String?         @map("inscription_id")
  type          TransactionType
  value         Decimal         @db.Decimal(10, 2)
  createdAt     DateTime        @default(now()) @map("created_at")
  updatedAt     DateTime        @updatedAt @map("updated_at")
  account       Accounts?       @relation(fields: [accountId], references: [id])
  event         Events          @relation(fields: [eventId], references: [id])
  inscription   Inscription?    @relation(fields: [inscriptionId], references: [id])

  ticketSalePayments  TicketSalePayment[]
  paymentInstallments PaymentInstallment[]

  @@index([inscriptionId])
  @@index([guestEmail])
  @@map("financial_movement")
}

model EventTickets {
  id              String           @id @default(uuid())
  eventId         String           @map("event_id")
  name            String
  description     String?
  quantity        Int
  price           Decimal          @db.Decimal(10, 2)
  available       Int
  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @updatedAt @map("updated_at")
  expirationDate  DateTime         @map("expiration_date")
  isActive        Boolean          @default(false) @map("is_active")
  event           Events           @relation(fields: [eventId], references: [id])
  ticketSaleItems TicketSaleItem[]

  @@map("event_tickets")
}

model TicketSale {
  id              String              @id @default(uuid())
  totalValue      Decimal             @db.Decimal(10, 2)
  createdAt       DateTime            @default(now()) @map("created_at")
  updatedAt       DateTime            @updatedAt @map("updated_at")
  email           String?
  name            String
  phone           String?
  status          TicketSaleStatus    @default(PENDING)
  eventId         String              @map("event_id")
  approvedBy      String?             @map("approved_by")
  ticketSaleItems TicketSaleItem[]
  payments        TicketSalePayment[]

  @@map("ticket_sales")
}

model TicketSalePayment {
  id                  String             @id @default(uuid())
  ticketSaleId        String             @map("ticket_sale_id")
  paymentMethod       PaymentMethod
  value               Decimal            @db.Decimal(10, 2)
  createdAt           DateTime           @default(now()) @map("created_at")
  financialMovementId String?
  imageUrl            String?            @map("image_url")
  financialMovement   FinancialMovement? @relation(fields: [financialMovementId], references: [id])
  sale                TicketSale         @relation(fields: [ticketSaleId], references: [id], onDelete: Cascade)

  @@map("ticket_sale_payments")
}

model TicketSaleItem {
  id           String       @id @default(uuid())
  ticketSaleId String       @map("ticket_sale_id")
  ticketId     String       @map("ticket_id")
  quantity     Int
  unitPrice    Decimal      @map("unit_price") @db.Decimal(10, 2)
  totalValue   Decimal      @map("total_value") @db.Decimal(10, 2)
  createdAt    DateTime     @default(now()) @map("created_at")
  updatedAt    DateTime     @updatedAt @map("updated_at")
  ticket       EventTickets @relation(fields: [ticketId], references: [id])
  sale         TicketSale   @relation(fields: [ticketSaleId], references: [id], onDelete: Cascade)
  TicketUnits  TicketUnit[]

  @@map("ticket_sale_items")
}

model TicketUnit {
  id               String         @id @default(uuid())
  qrCode           String         @unique
  usedAt           DateTime?
  createdAt        DateTime       @default(now()) @map("created_at")
  ticketSaleItemId String         @map("ticket_sale_item_id")
  item             TicketSaleItem @relation(fields: [ticketSaleItemId], references: [id], onDelete: Cascade)

  @@map("ticket_units")
}

model EventExpenses {
  id            String        @id @default(uuid())
  eventId       String        @map("event_id")
  description   String
  value         Decimal       @db.Decimal(10, 2)
  paymentMethod PaymentMethod
  responsible   String
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")
  event         Events        @relation(fields: [eventId], references: [id])

  @@map("event_expenses")
}

enum InscriptionStatus {
  PENDING
  UNDER_REVIEW
  PAID
  EXPIRED
  CANCELLED
}

enum TicketSaleStatus {
  PENDING
  UNDER_REVIEW
  PAID
  CANCELLED
}

enum roleType {
  USER
  MANAGER
  ADMIN
  SUPER
}

enum statusEvent {
  OPEN
  CLOSE
  FINALIZED
}

enum genderType {
  MASCULINO
  FEMININO
}

enum StatusPayment {
  APPROVED
  UNDER_REVIEW
  REFUSED
}

enum TransactionType {
  INCOME
  EXPENSE
}

enum PaymentMethod {
  DINHEIRO
  PIX
  CARTAO
}

enum ShirtSize {
  PP
  P
  M
  G
  GG
  XG
}

enum ShirtType {
  TRADICIONAL
  BABYLOOK
}
